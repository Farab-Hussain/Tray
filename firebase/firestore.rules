rules_version = '2';
service cloud.firestore {
match /databases/{database}/documents {

// Helper function to check if user is authenticated
function isAuthenticated() {
return request.auth != null                          ;
}

// Helper function to check if user owns the document
function isOwner(userId) {
return isAuthenticated() && request.auth.uid == userId ;
}

// Users collection
match /users/{userId} {
// Users can read their own data, admins can read all
allow read: if isAuthenticated() && (request.auth.uid == userId) ;
// Only admins can write to users collection
allow write: if false                                            ; // Backend only via Admin SDK
}

// FCM Tokens subcollection
match /users/{userId}/fcmTokens/{tokenId} {
allow read, write: if isOwner(userId)       ;
}

// Chats collection
match /chats/{chatId} {
// Users can only read chats they're a participant in
allow read: if isAuthenticated() &&
(request.auth.uid in resource.data.participants)         ;
// Users can only create chats they're a participant in
allow create: if isAuthenticated() &&
(request.auth.uid in request.resource.data.participants) ;
// Users can only update chats they're a participant in
allow update: if isAuthenticated() &&
(request.auth.uid in resource.data.participants)         ;
// Users cannot delete chats
allow delete: if false                                   ;
}

// Messages subcollection
match /chats/{chatId}/messages/{messageId} {
// Users can read messages from chats they're in
allow read: if isAuthenticated()                   ;
// Users can create messages
allow create: if isAuthenticated() &&
request.resource.data.senderId == request.auth.uid ;
// Users cannot update or delete messages
allow update, delete: if false                     ;
}

// Notifications collection
match /notifications/{notificationId} {
// Users can only read their own notifications
allow read: if isAuthenticated() &&
(request.auth.uid == resource.data.userId)                                  ;
// Allow authenticated users to create notifications for any user
// This is needed for chat messages and other in-app notifications
// The backend will also create notifications via Admin SDK
allow create: if isAuthenticated()                                          ;
// Users can update their own notifications (e.g., mark as read)
allow update: if isAuthenticated() &&
(request.auth.uid == resource.data.userId) &&
// Only allow updating read field
request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read']);
// Users cannot delete notifications
allow delete: if false                                                      ;
}

// Bookings collection
match /bookings/{bookingId} {
// Users can read bookings they're involved in
allow read: if isAuthenticated() &&
(request.auth.uid == resource.data.studentId ||
request.auth.uid == resource.data.consultantId)          ;
// Only backend can create/update bookings via Admin SDK
allow write: if false                                    ;
}

// Reviews collection
match /reviews/{reviewId} {
// Anyone can read reviews
allow read: if true                            ;
// Only authenticated users can create reviews
allow create: if isAuthenticated()             ;
// Users cannot update or delete reviews
allow update, delete: if false                 ;
}

// Consultant profiles collection
match /consultants/{consultantId} {
// Anyone can read consultant profiles
allow read: if true                     ;
// Only backend can write via Admin SDK
allow write: if false                   ;
}

// Services collection
match /services/{serviceId} {
// Anyone can read services
allow read: if true                     ;
// Only backend can write via Admin SDK
allow write: if false                   ;
}

// Calls collection (WebRTC)
match /calls/{callId} {
// Users can read calls they're involved in (caller or receiver)
allow read: if isAuthenticated() &&
(request.auth.uid == resource.data.callerId ||
request.auth.uid == resource.data.receiverId)                     ;
// Users can create calls where they are the caller
allow create: if isAuthenticated() &&
request.auth.uid == request.resource.data.callerId                ;
// Users can update calls they're involved in (e.g., answer, end)
allow update: if isAuthenticated() &&
(request.auth.uid == resource.data.callerId ||
request.auth.uid == resource.data.receiverId)                     ;
// Users cannot delete calls
allow delete: if false                                            ;
}

// ICE Candidates subcollection
match /calls/{callId}/candidates/{candidateId} {
// Helper to check if user is involved in the parent call
function isCallParticipant() {
let callDoc = get(/databases/$(database)/documents/calls/$(callId))                              ;
// If call document doesn't exist yet (race condition during call setup), allow if authenticated
// This handles the case where ICE candidates are generated before call document is created
return isAuthenticated() &&
(!exists(callDoc) ||
request.auth.uid == callDoc.data.callerId ||
request.auth.uid == callDoc.data.receiverId)                                                     ;
}

// Users can read candidates for calls they're involved in
allow read: if isCallParticipant()                                                  ;
// Users can create candidates for calls they're involved in and must be the sender
allow create: if isCallParticipant() &&
request.auth.uid == request.resource.data.senderId                                  ;
// Users cannot update or delete candidates
allow update, delete: if false                                                      ;
}

// Default: deny all other access
match /{document=**} {
allow read, write: if false       ;
}
}
}
